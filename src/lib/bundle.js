!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Datafeeds={})}(this,function(e){"use strict";var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function u(e){return void 0===e?"":"string"==typeof e?e:e.message}var o=function(){function e(e,t){this._datafeedUrl=e,this._requester=t}return e.prototype.getResolutionMiliSec=function(e){return e.match(/\d$/)?60*e*1e3:e.match(/D/)?(e=e.replace(/^D$/,"1D"),60*parseInt(e)*1e3*60*24):void 0},e.prototype.getBars=function(e,t,r,s){var n=this,o=e.name.split(/[:/]/),i=t;t.match(/\d$/)?t+="m":t.match(/D/)&&(t=t.replace(/D/,"d").replace(/^d/,"1d")),60<=parseInt(t)&&(t=parseInt(t)/60+"h");var a={pair:o[1]+"_"+o[2],type:t,start:1e3*r,limit:s?Math.ceil(Math.abs(1e3*r-1e3*s)/this.getResolutionMiliSec(i))+1:500,end:1e3*s};return new Promise(function(o,i){n._requester.sendRequest(n._datafeedUrl,a).then(function(e){if("success"===e.message||e.data){var t=[],r={noData:!1};if(0===e.data.length)r.noData=!0;else for(var s=0;s<e.data.length;++s){var n={time:e.data[s][0],open:Number(e.data[s][1]),high:Number(e.data[s][2]),low:Number(e.data[s][3]),close:Number(e.data[s][4]),volume:Number(e.data[s][5])};t.push(n)}o({bars:t,meta:r})}else i(e.errmsg)}).catch(function(e){var t=u(e);console.warn("HistoryProvider: getBars() failed, error="+t),i(t)})})},e}(),i=function(){function e(e,t){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),t)}return e.prototype.subscribeBars=function(e,t,r,s){this._subscribers.hasOwnProperty(s)||(this._subscribers[s]={lastBarTime:null,listener:r,resolution:t,symbolInfo:e},e.name)},e.prototype.unsubscribeBars=function(e){delete this._subscribers[e]},e.prototype._updateData=function(){var t=this;if(!(0<this._requestsPending)){this._requestsPending=0;var e,r=this;for(var s in this._subscribers)e=s,r._requestsPending+=1,r._updateDataForSubscriber(e).then(function(){t._requestsPending-=1,t._requestsPending}).catch(function(e){t._requestsPending-=1,u(e),t._requestsPending})}},e.prototype._updateDataForSubscriber=function(t){var r=this,e=this._subscribers[t],s=parseInt((Date.now()/1e3).toString()),n=s-function(e,t){var r=0;r="D"===e||"1D"===e?t:"M"===e||"1M"===e?31*t:"W"===e||"1W"===e?7*t:t*parseInt(e)/1440;return 24*r*60*60}(e.resolution,2);return this._historyProvider.getBars(e.symbolInfo,e.resolution,n,s).then(function(e){r._onSubscriberDataReceived(t,e)})},e.prototype._onSubscriberDataReceived=function(e,t){if(this._subscribers.hasOwnProperty(e)){var r=t.bars;if(0!==r.length){var s=r[r.length-1],n=this._subscribers[e];if(!(null!==n.lastBarTime&&s.time<n.lastBarTime)){if(null!==n.lastBarTime&&s.time>n.lastBarTime){if(r.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");var o=r[r.length-2];n.listener(o)}n.lastBarTime=s.time,n.listener(s)}}}},e.prototype._onManualSetBarsData=function(e,t){if(this._subscribers.hasOwnProperty(e)){var r=t.bars;if(0!==r.length){var s=r[r.length-1],n=this._subscribers[e];if(!(null!==n.lastBarTime&&s.time<n.lastBarTime)){if(null!==n.lastBarTime&&s.time>=n.lastBarTime){if(r.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");var o=r[r.length-1];n.listener(o)}n.lastBarTime=s.time,n.listener(s)}}}},e.prototype.manualSetBars=function(e,t){var r={bars:null};if(this._subscribers.hasOwnProperty(e)&&-1<Object.prototype.toString.call(t).indexOf("Array")){for(var s=[],n=0;n<t.length;n++){var o={time:t[n][0],open:Number(t[n][1]),high:Number(t[n][2]),low:Number(t[n][3]),close:Number(t[n][4]),volume:Number(t[n][5])};s.push(o)}r.bars=s,this._onManualSetBarsData(e,r)}},e}();function l(e,t,r){var s=e[t];return Array.isArray(s)?s[r]:s}var t=function(){function e(e,t,r){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=r,this._readyPromise=this._init(),this._readyPromise.catch(function(e){console.error("SymbolsStorage: Cannot init, error="+e.toString())})}return e.prototype.resolveSymbol=function(t){var r=this;return this._readyPromise.then(function(){var e=r._symbolsInfo[t];return void 0===e?Promise.reject("invalid symbol"):Promise.resolve(e)})},e.prototype.searchSymbols=function(a,u,c,n){var p=this;return this._readyPromise.then(function(){var o=[],i=0===a.length;a=a.toUpperCase();for(var e=function(e){var t=p._symbolsInfo[e];if(void 0===t)return"continue";if(0<c.length&&t.type!==c)return"continue";if(u&&0<u.length&&t.exchange!==u)return"continue";var r=t.name.toUpperCase().indexOf(a),s=t.description.toUpperCase().indexOf(a);if((i||0<=r||0<=s)&&!o.some(function(e){return e.symbolInfo===t})){var n=0<=r?r:8e3+s;o.push({symbolInfo:t,weight:n})}},t=0,r=p._symbolsList;t<r.length;t++){e(r[t])}var s=o.sort(function(e,t){return e.weight-t.weight}).slice(0,n).map(function(e){var t=e.symbolInfo;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}});return Promise.resolve(s)})},e.prototype._init=function(){for(var e=this,t=[],r={},s=0,n=this._exchangesList;s<n.length;s++){var o=n[s];r[o]||(r[o]=!0,t.push(this._requestExchangeData(o)))}return Promise.all(t).then(function(){e._symbolsList.sort()})},e.prototype._requestExchangeData=function(s){var n=this;return new Promise(function(t,r){n._requester.sendRequest(n._datafeedUrl,{group:s}).then(function(e){try{n._onExchangeDataReceived(s,e)}catch(e){return void r(e)}t()}).catch(function(e){u(e),t()})})},e.prototype._onExchangeDataReceived=function(t,r){var e=this,s=0;try{for(var n=r.symbol.length,o=void 0!==r.ticker;s<n;++s){var i=r.symbol[s],a=l(r,"exchange-listed",s),u=l(r,"exchange-traded",s),c=u+":"+i,p=o?l(r,"ticker",s):i,h={ticker:p,name:i,base_name:[a+":"+i],full_name:c,listed_exchange:a,exchange:u,description:l(r,"description",s),has_intraday:f(l(r,"has-intraday",s),!1),has_no_volume:f(l(r,"has-no-volume",s),!1),minmov:l(r,"minmovement",s)||l(r,"minmov",s)||0,minmove2:l(r,"minmove2",s)||l(r,"minmov2",s),fractional:l(r,"fractional",s),pricescale:l(r,"pricescale",s),type:l(r,"type",s),session:l(r,"session-regular",s),timezone:l(r,"timezone",s),supported_resolutions:f(l(r,"supported-resolutions",s),e._datafeedSupportedResolutions),force_session_rebuild:l(r,"force-session-rebuild",s),has_daily:f(l(r,"has-daily",s),!0),intraday_multipliers:f(l(r,"intraday-multipliers",s),["1","5","15","30","60"]),has_weekly_and_monthly:l(r,"has-weekly-and-monthly",s),has_empty_bars:l(r,"has-empty-bars",s),volume_precision:f(l(r,"volume-precision",s),0)};e._symbolsInfo[p]=h,e._symbolsInfo[i]=h,e._symbolsInfo[c]=h,e._symbolsList.push(i)}}catch(e){throw new Error("SymbolsStorage: API error when processing exchange "+t+" symbol #"+s+" ("+r.symbol[s]+"): "+e.message)}},e}();function f(e,t){return void 0!==e?e:t}var a=["1","5","15","30","60","360","720","1D"],r=function(){function e(e,t,r){void 0===r&&(r=1e4);var s=this;this._configuration={supports_search:!1,supports_group_request:!1,supported_resolutions:["1","5","15","30","60","360","720","1D"],supports_marks:!1,supports_timescale_marks:!1},this._symbolsStorage=null,this._datafeedURL=e,this._requester=t,this._historyProvider=new o(e,this._requester),this._dataPulseProvider=new i(this._historyProvider,r),this._configurationReadyPromise=this._requestConfiguration().then(function(e){null===e&&(e={supports_search:!1,supports_group_request:!1,supported_resolutions:["1","5","15","30","60","360","720","1D"],supports_marks:!1,supports_timescale_marks:!1}),s._setupWithConfiguration(e)})}return e.prototype.onReady=function(e){var t=this;this._configurationReadyPromise.then(function(){e(t._configuration)})},e.prototype.getQuotes=function(e,t,r){},e.prototype.subscribeQuotes=function(e,t,r,s){},e.prototype.unsubscribeQuotes=function(e){},e.prototype.calculateHistoryDepth=function(e,t,r){},e.prototype.getMarks=function(e,t,r,s,n){},e.prototype.getTimescaleMarks=function(e,t,r,s,n){},e.prototype.getServerTime=function(r){this._configuration.supports_time&&this._send("time").then(function(e){var t=parseInt(e);isNaN(t)||r(t)}).catch(function(e){u(e)})},e.prototype.searchSymbols=function(e,t,r,s){if(this._configuration.supports_search){var n={limit:30,query:e.toUpperCase(),type:r,exchange:t};this._send("search",n).then(function(e){if(void 0!==e.s)return e.errmsg,void s([]);s(e)}).catch(function(e){u(e),s([])})}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,r,30).then(s).catch(s.bind(null,[]))}},e.prototype.resolveSymbol=function(e,r,t){var s=e.split(/[:/]/),n={name:e,description:"",type:"crypto",session:"24x7",timezone:"Etc/UTC",exchange:"",ticker:e,minmov:1,pricescale:1e5,has_intraday:!0,intraday_multipliers:["1","5","15","30","60","360","720"],supported_resolution:a,volume_precision:2,data_status:"streaming",has_empty_bars:!0};new Promise(function(t,e){fetch("/api/me/colaCoinSymbol/getPairPrecision?pair="+s[1]+"_"+s[2]).then(function(e){return e.json()}).then(function(e){try{n.pricescale=Math.pow(10,e.data[0].precision.priceScale)}catch(e){n.pricescale=1e4}finally{t(r(n))}}).catch(function(e){n.pricescale=1e4,t(r(n))})})},e.prototype.getBars=function(e,t,r,s,n,o){this._historyProvider.getBars(e,t,r,s).then(function(e){n(e.bars,e.meta)}).catch(o)},e.prototype.subscribeBars=function(e,t,r,s,n){this._dataPulseProvider.subscribeBars(e,t,r,s)},e.prototype.unsubscribeBars=function(e){this._dataPulseProvider.unsubscribeBars(e)},e.prototype._requestConfiguration=function(){return new Promise(function(e,t){setTimeout(function(){e({supports_search:!0,supports_group_request:!1,supports_marks:!0,supports_timescale_marks:!0,supports_time:!0,exchanges:[{value:"",name:"All Exchanges",desc:""},{value:"NasdaqNM",name:"NasdaqNM",desc:"NasdaqNM"},{value:"NYSE",name:"NYSE",desc:"NYSE"},{value:"NCM",name:"NCM",desc:"NCM"},{value:"NGM",name:"NGM",desc:"NGM"}],symbols_types:[{name:"All types",value:""},{name:"Stock",value:"stock"},{name:"Index",value:"index"}],supported_resolutions:["1","5","15","30","60","360","720","1D"]})},50)}).then(function(e){return e})},e.prototype._send=function(e,t){return this._requester.sendRequest(this._datafeedURL,t)},e.prototype._setupWithConfiguration=function(e){if(void 0===(this._configuration=e).exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new t(this._datafeedURL,e.supported_resolutions||[],this._requester)),JSON.stringify(e)},e}();var c=function(){function e(e){e&&(this._headers=e)}return e.prototype.sendRequest=function(e,t){if(void 0!==t){var r="",s=Object.keys(t);0!==s.length&&(r+="?"),r+=s.map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e].toString())}).join("&")}var n={credentials:"same-origin"};return void 0!==this._headers&&(n.headers=this._headers),fetch(e+"/"+r,n).then(function(e){return e.text()}).then(function(e){return JSON.parse(e)})},e}(),s=function(s){function e(e,t){void 0===t&&(t=1e4);var r=new c;return s.call(this,e,r,t)||this}return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(e,s),e}(r);e.UDFCompatibleDatafeed=s,Object.defineProperty(e,"__esModule",{value:!0})});
